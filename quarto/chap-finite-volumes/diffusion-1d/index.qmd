# Diffusion in 1-D {#sec-diffusion-1d}

```{python}
%load_ext autoreload
%autoreload 2
```

```{python}
from sympy import Eq
from sympy import expand
from diffusion import FvmVars, CellVars, FaceVars
from diffusion import diffusion_flux
import diffusion
```

## Introductory Fickean diffusion

Assume a simple concentration-dependent diffusion in the absence of external driving forces; in this introduction we chose to _model_ the diffusive flux through Fick's constitutive (first) law stated below, where $D$ is the diffusion coefficient that may depend on position $x$ and/or concentration $c$, _i.e._ $D\equiv{}D(x, c)$. It states that diffusive flux of an species has the composition gradient as a driver force; the negative sign indicates that diffusion occurs from high to low concentration regions.

$$
J=-D\dfrac{\partial{}c}{\partial{}x}
$$

We can anticipate here that this can be the case for simple diluted systems, but interactions between species must be considered in concentrated solutions, what is generalized by the _Irreversible Thermodynamics_ by @Onsager1931 and @Onsager1931a. Here we emphasize again the word _model_: empirical observation has led scientists to _represent_ reality through such an approximation; different models can be used for the same physics with their applicability limited to certain scenarios. Properly selecting an applicable model is the role of the researcher/engineer, what is outside our scope here; in what follows we will focus on _how to solve_ balance equations for a given model.

Simply put, diffusion equation solves for a local mass balance; and mathematically, a local balance leads to a divergence operation. Following this idea, it can be shown that the time derivative of concentration $c$ at one location is given by the divergence - which collapses to the spatial derivative - of the negative of mass flux given by Fick's (first) law (or in general any other constitutive law/model describing the mass flux); sometimes this form is called Fick's second law in the literature. Given the possible nonlinearity introduced by diffusion coefficient $D$, the derivative in the right-hand side is not expanded. In Cartesian coordinate system, the governing diffusion equation in one dimension writes:

$$
\dfrac{\partial{}c}{\partial{}t}=
\dfrac{\partial{}}{\partial{}x}
\left(D\dfrac{\partial{}c}{\partial{}x}\right)
$$

This is the form of the diffusion equation that is discussed in what follows.

## Internal discretization

To solve the diffusion equation numerically, we employ the finite volume method (FVM). The first step to establish a FVM scheme consists of integrating the governing equation over a control volume $P$ from $w$ (west face) to $e$ (east face) and over a time interval from $0$ to $\tau$. The left-hand side is first integrated over time as it represents a _storage_ term, meaning that it measures how much the average concentration changes in the control volume over the time-step. The right-hand side is a _flux_ term, and using similar arguments its _natural_ integration is performed over space. Also, the order of integration can be exchanged due to the smoothness assumptions considered here. For more details, please check @Patankar1980.

$$
\int_{w}^{e}\int_{0}^{\tau}
\dfrac{\partial{}c}{\partial{}t}dt\:dx=
\int_{0}^{\tau}\int_{w}^{e}
\dfrac{\partial{}}{\partial{}x}
\left(D\dfrac{\partial{}c}{\partial{}x}\right)dx\:dt
$$

This double integration allows us to convert the partial differential equation into a form suitable for numerical discretization. Evaluating the innermost integrals leads to:

$$
\int_{w}^{e}
\left(c_{P}-c_{P}^{0}\right)\:dx=
\int_{0}^{\tau}
\left[
    \left(D\dfrac{\partial{}c}{\partial{}x}\right)_{e}-
    \left(D\dfrac{\partial{}c}{\partial{}x}\right)_{w}
\right]
\:dt
$$

Here, $c_P^0$ and $c_P$ represent the concentration at the center of the control volume $P$ at times $0$ and $\tau$, respectively. A convention of not adding a superscript to time $\tau$ is adopted here, unless required by the context. The right-hand side represents the net flux into the control volume through its east and west faces. Assuming the concentration is uniform within each control volume and the fluxes are constant over the time interval, we obtain:

$$
\left(c_{P}-c_{P}^{0}\right)
\dfrac{\delta}{\tau}=
\left(D\dfrac{\partial{}c}{\partial{}x}\right)_{e}-
\left(D\dfrac{\partial{}c}{\partial{}x}\right)_{w}
$$

where $\delta$ is the width of the control volume. This equation represents a discrete time-step of the diffusion equation for a single control volume, where one still needs to specify a discretization of the gradients, _i.e._ how the fluxes are evaluated at a cell face. A simple introductory approach is to use forward differences, where the composition gradients are approximated as first differences between neighbors.

Below we compose this expression with help of [SymPy](https://docs.sympy.org/latest/index.html). Notice that when compositing the right-hand side `rhs` we multiply by -1 because we are integrating the negative of the fluxes.

<!--
\left(c_{P}-c_{P}^{0}\right)
\dfrac{\delta}{\tau}=
D_{e}\dfrac{c_{E}-c_{P}}{\delta}-
D_{w}\dfrac{c_{P}-c_{W}}{\delta}
-->

```{python}
J_w = diffusion_flux(FaceVars.D_w, CellVars.c_W, CellVars.c_P)
J_e = diffusion_flux(FaceVars.D_e, CellVars.c_P, CellVars.c_E)

lhs = (CellVars.c_P - CellVars.c_0) * FvmVars.delta / FvmVars.tau
rhs = -1 * (J_e - J_w)

eq = Eq(lhs - rhs, 0)
eq
```

Here, $c_E$ and $c_W$ are the concentrations at the eastern and western neighboring control volumes, respectively, and $D_e$ and $D_w$ are the effective diffusion coefficients at the east and west faces of the control volume. @Patankar1980 shows that the evaluation of these diffusion coefficients is not arbitrary and for conservation (here the continuity of flux across the interface) to be respected one must take the harmonic mean of neighboring cells:

$$
D_{k}=2\frac{D_{i}D_{j}}{D_{i}+D_{j}}
$$

A final step to get a linear form of the problem is multiplying both sides by $\tau/\delta$ and rearranging terms. This form clearly shows the contribution of each neighboring concentration to the rate of change at point P. The coefficient of $c_P$ is negative, representing the outflow from the central node, while the coefficients of $c_E$ and $c_W$ are positive, representing inflow from the neighboring nodes.

<!--
c_{P}-c_{P}^{0}=
\dfrac{\tau}{\delta^2}\left[
    D_{e}c_{E}-(D_{e}+D_{w})c_{P}+D_{w}c_{W}
\right]
-->

```{python}
eq = Eq(expand(eq.lhs * FvmVars.tau / FvmVars.delta), 0)
eq
```

Introducing dimensionless coefficients $\alpha_{k}$, the [Fourier number](https://en.wikipedia.org/wiki/Fourier_number) for mass transfer (more generally referred to as $\mathcal{Fo}_{m}$), we obtain the final discretized form. It represents the dimensionless diffusion number, which determines the stability and accuracy of the numerical scheme. The subscript $k$ refers to either the east ($e$) or west ($w$) face.

$$
\alpha_{k}=\dfrac{\tau{}D_{k}}{\delta^2}
$$

<!--
c_{P}-c_{P}^{0}=
\alpha_{e}c_{E}-(\alpha_{e}+\alpha_{w})c_{P}+\alpha_{w}c_{W}
-->

Performing the replacements with help of SymPy:

```{python}
eq = Eq(eq.lhs.subs(diffusion.SUBS_FOURIER), 0)
eq
```

Notice that so far nothing has been said with respect to the instant at which the right-hand side is evaluated. The obvious solution would be to take $c_{0}\equiv{}c_{P}^{0}$ as it is currently known, but for numerical stability reasons we will continue here with an implicit scheme so that all values other than $c_{0}$ are defined to be evaluated at time $\tau$, _i.e._ $c_{K}\equiv{}c_{K}^{\tau}$, in phase with the notation convention introduced above.

Because it is more convenient for symbolic manipulations with SymPy, the problem is currently writen as $F(c)=0$, _i.e._ all elements are on the left-hand side. Care must be taken to properly interpret the signs of the coefficients below.

```{python}
variables = [CellVars.c_0, CellVars.c_P, CellVars.c_E, CellVars.c_W]
coefs = diffusion.get_fv_coefficients(eq.lhs, variables)
coefs
```

Because it is mor readable, a helper utility is provided to tabulate them:

```{python}
variables = [CellVars.c_0, CellVars.c_P, CellVars.c_E, CellVars.c_W]
diffusion.tabulate_fv_coefs(eq.lhs, variables)
```

<!--
c_{P}^{\tau}-c_{P}^{0}=
\alpha_{e}^{\tau}c_{E}^{\tau}-
(\alpha_{e}^{\tau}+\alpha_{w}^{\tau})c_{P}^{\tau}+
\alpha_{w}^{\tau}c_{W}^{\tau}

Each cell in the triple has its coefficient and a more convenient form (for later programming its solution) is established by representing the equation as

A_{W}c_{W}^{\tau} + A_{P}c_{P}^{\tau} + A_{E}c_{E}^{\tau} = c_{P}^{0}

where

\begin{align*}
A_{P} &= 1 + \alpha_{e}^{\tau}+\alpha_{w}^{\tau}
\\[6pt]
A_{E} &= -\alpha_{e}^{\tau}
\\[6pt]
A_{W} &= -\alpha_{w}^{\tau}
\end{align*}
-->

{{< include bc-part-1.qmd >}}
{{< include bc-part-2.qmd >}}
{{< include solution.qmd >}}
{{< include proto.qmd >}}
