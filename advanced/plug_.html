
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Plug flow coupling &#8212; Majordome  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'advanced/plug_';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Acetylene pyrolysis" href="plug_phd_.html" />
    <link rel="prev" title="Advanced" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Majordome  documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Majordome</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../examples/index.html">Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples/common_.html">Common utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/energy_.html">Energy models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/fluent_.html">Fluent files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/reactor_.html">Reactor models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/transport_.html">Transport properties</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Advanced</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Plug flow coupling</a></li>
<li class="toctree-l2"><a class="reference internal" href="plug_phd_.html">Acetylene pyrolysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="pyvista_tips_.html">PyVista recipes</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../modules/index.html">API Docs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/common.html">majordome.common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/energy.html">majordome.energy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/fluent.html">majordome.fluent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/latex.html">majordome.latex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/plotting.html">majordome.plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/reactor.html">majordome.reactor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/transport.html">majordome.transport</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../teaching/index.html">Teaching</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../teaching/calphad_iron_nitrogen_.html">Equilibrium in Fe-N system</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../computing/index.html">Computing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../computing/introduction.html">Scientific computing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/tools-git.html">Git version control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/tools-ssh.html">SSH key generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/tools-containers.html">Using containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/tools-selection.html">Selection of tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/tools-portable.html">Portable toolbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/system-windows.html">Working on Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/system-linux.html">Working on Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/ansys-fluent/tui.html">Text user interface (TUI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/elmer-csc/elmer.html">Elmer Multiphysics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/general-tips.html">General Tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../computing/services.html">Deploying services</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../programming/index.html">Programming</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../programming/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../programming/julia-tips.html">Julia tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../programming/racket.html">Programming in Racket</a></li>
<li class="toctree-l2"><a class="reference internal" href="../programming/haskell.html">Minimal Haskell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../programming/other.html">Other languages</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../developers/index.html">Development</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../developers/devel.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/onkwargs_.html">A note on <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> parsing</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/advanced/plug_.py" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.py</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Plug flow coupling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Shared-functionalities">Shared functionalities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Single-plug-flow-reactor">Single plug-flow reactor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---single-PFR-simulation">Example - single PFR simulation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Counter-current-flow-reactors">Counter-current flow reactors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---pair-of-coupled-PFR">Example - pair of coupled PFR</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Adding-losses-to-the-environment">Adding losses to the environment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---environment-coupling">Example - environment coupling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Registering-flow-for-a-single-reactor">Registering flow for a single reactor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---prototype-with-a-single-reactor">Example - prototype with a single reactor</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Registering-flow-for-a-pair-of-reactors">Registering flow for a pair of reactors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---extension-to-coupled-system">Example - extension to coupled system</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Plug-flow-coupling">
<h1>Plug flow coupling<a class="headerlink" href="#Plug-flow-coupling" title="Link to this heading">#</a></h1>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Link to this heading">#</a></h2>
<p>The goal of this tutorial is to discuss a sequence of increasingly complex plug-flow reactor (PFR) models. These are all built upon <code class="docutils literal notranslate"><span class="pre">PlugFlowChainCantera</span></code> which approximates a PFR as a cascade of perfect-stirred reactors (PSR), as illustrated <a class="reference external" href="https://cantera.org/stable/examples/python/reactors/pfr.html#sphx-glr-examples-python-reactors-pfr-py">here</a>. Care must be taken when using such an approach because this zero-dimensional modeling does not formally represent a PFR, but approaches one -
so grid convergence studies might be required to validate a model, what is beyond our scope here (and has been done during the conception of this report), which limits itself to studying the coupling of reactors. Nonetheless, this representation proves very interesting when assembling complex systems as it remains modular, allowing for extensibility of models.</p>
<p>In what follows we will be guided through the following models:</p>
<ul class="simple">
<li><p>A single PFR with possibility of distributed mass sources along its length; this case is often encountered in industry when modeling reactors coupled through a permeable membrane, or in a rotary kiln, where solids may eventually release gases, what is especially important in the field of biomatter gaseification.</p></li>
<li><p>Next we will couple a pair of reactors as conceived in the first example, which will be allowed to exchange energy through a pseudo-convective model; there is no major difficulty at this point as the coupling can be stabilized through a relaxation routine. We investigate how the ordering of reactor solution affects convergence rate.</p></li>
<li><p>At the last level of complexity studied here, we add a shared common wall around the pair of reactors of the previous step; one might argue that such a system would require two <em>wall</em> temperatures to be described at steady state; here we will assume that this wall is <em>rotating</em> around the pair of reactors in such a way that it remains in contact with a reactor during part of a cycle, and a <em>statistically significant mean temperature</em> is solely used as a process measurable.</p></li>
</ul>
<p>Because writting long classes is not didatic for the purposes of a tutorial, we will use a <em>semi-object-oriented</em> programming approach here. That means, there will be minimal classes just holding the basic elements representing the state of a problem, and functions that resemble class methods (receiving the class instance as first argument) to perform the required operations.</p>
<p>Below we start by importing all required tools at once:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="o">%</span><span class="k">load_ext</span> majordome.skipper
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">majordome</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">PlugFlowChainCantera</span><span class="p">,</span> <span class="n">RelaxUpdate</span><span class="p">,</span>
                       <span class="n">StabilizeNvarsConvergenceCheck</span><span class="p">,</span>
                       <span class="n">ComposedStabilizedConvergence</span><span class="p">,</span>
                       <span class="n">standard_plot</span><span class="p">,</span> <span class="n">get_reactor_data</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NDArray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tabulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cantera</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Because some cells take some time to execute, during development you can set this to <code class="docutils literal notranslate"><span class="pre">&quot;true&quot;</span></code> so that they are not run. You can recognize these cells by the presence of magic <code class="docutils literal notranslate"><span class="pre">%%skipper</span></code>. Setting this to <code class="docutils literal notranslate"><span class="pre">&quot;false&quot;</span></code> will not skip the cells (this is the logic of the booleans here, we are saying true to skip, not true to execute!).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MJ_SOLVE_FINEST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="Shared-functionalities">
<h2>Shared functionalities<a class="headerlink" href="#Shared-functionalities" title="Link to this heading">#</a></h2>
<p>This section is not commented, variables and functions should speak by themselves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_AIR</span> <span class="o">=</span> <span class="s2">&quot;N2: 0.79, O2: 0.21&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">dicretize_length</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">dL</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Discretize length L in cells of length `dL`. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dL</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="n">dL</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">dL</span><span class="p">,</span> <span class="n">dL</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Single-plug-flow-reactor">
<h2>Single plug-flow reactor<a class="headerlink" href="#Single-plug-flow-reactor" title="Link to this heading">#</a></h2>
<p>For the single reactor <code class="docutils literal notranslate"><span class="pre">ReactorModel</span></code> we write a simple wrapper around <code class="docutils literal notranslate"><span class="pre">PlugFlowChainCantera</span></code>; this model holds an instance of a <code class="docutils literal notranslate"><span class="pre">solution</span></code> object conceived with the same mechanism as provided to the PFR, and a simple <code class="docutils literal notranslate"><span class="pre">source</span></code> structure for the distributed source terms.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ReactorModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wrapper model for creation of a plug flow reactor. &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">mech</span><span class="o">=</span><span class="s2">&quot;airish.yaml&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">sol</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">Solution</span><span class="p">(</span><span class="n">mech</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span>  <span class="o">=</span> <span class="n">PlugFlowChainCantera</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span>   <span class="o">=</span> <span class="n">get_reactor_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Both the <code class="docutils literal notranslate"><span class="pre">solution</span></code> and <code class="docutils literal notranslate"><span class="pre">source</span></code> are used in <code class="docutils literal notranslate"><span class="pre">add_source</span></code> to inject a mass flow rate <code class="docutils literal notranslate"><span class="pre">mdot</span></code> at temperature <code class="docutils literal notranslate"><span class="pre">T</span></code>, and composition <code class="docutils literal notranslate"><span class="pre">X</span></code> (given in mole fractions) at a set of cell indices <code class="docutils literal notranslate"><span class="pre">where</span></code> along the reactor. We will see later how discretization is performed and thus how to link <code class="docutils literal notranslate"><span class="pre">where</span></code> to an actual axial coordinate along the reactor.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">add_source</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">mdot</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Set axial source terms along reactor. &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">TPX</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">X</span>
    <span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">h</span>
    <span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">Y</span>
</pre></div>
</div>
</div>
<p>The underlining PFR model has already its own solution method (which is actually called <code class="docutils literal notranslate"><span class="pre">update</span></code>) that <em>seeks</em> a steady state for the reactor given a certaing <code class="docutils literal notranslate"><span class="pre">source</span></code>; sometimes it fail to converge and multiple calls may be required to find the steady state of a reactor. In <code class="docutils literal notranslate"><span class="pre">solve_reactor</span></code> below we wrap the aforementioned method and add some reporting.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Solve reactor model with provided source terms. &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;Total mass flow rate&quot;</span><span class="p">,</span> <span class="s2">&quot;g/s&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;Total external power&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span>   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">Q_cell</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;Final temperature &quot;</span><span class="p">,</span>   <span class="s2">&quot;K&quot;</span><span class="p">,</span>   <span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;github&quot;</span><span class="p">,</span> <span class="n">floatfmt</span><span class="o">=</span><span class="s1">&#39;+.6e&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<section id="Example---single-PFR-simulation">
<h3>Example - single PFR simulation<a class="headerlink" href="#Example---single-PFR-simulation" title="Link to this heading">#</a></h3>
<p>As this first case is already fully supported by the underlining library class, we are ready to solve a first example problem. Comments are provided in the function <code class="docutils literal notranslate"><span class="pre">sample_single</span></code> to guide you through the setup. A distributed power supply is added to the reactor as an analytical function as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}Q(z) = \begin{cases}
A \left[1 - \exp\left(-\dfrac{z}{z_0}\right)\right] &amp; z &lt; \dfrac{L}{2}\\[12pt]
0 &amp; \text{otherwise}
\end{cases}\end{split}\]</div>
<p>This is arbitrarily parametrized and is intended just to show that accessing <code class="docutils literal notranslate"><span class="pre">model.source.Q</span></code> allows to provide any heat source function to a reactor.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sample_single</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">report_first</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Single reactor model sample. &quot;&quot;&quot;</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mf">0.10</span>   <span class="c1"># Reactor diameter [m]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c1"># Reactor length [m]</span>

    <span class="c1"># Volume of a single cell [m³]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">D</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Discretize length in equal length cells [m].</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">dicretize_length</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

    <span class="c1"># Find indexes where z&gt;0.2 and z&lt;=0.4 m to apply some</span>
    <span class="c1"># distributed gas injection (to test robustness of method).</span>
    <span class="n">dilute</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">))</span>

    <span class="c1"># Create reactor with equal volume cells:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="p">))</span>

    <span class="c1"># Compute a power supply function:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mf">9_481.15</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z</span> <span class="o">/</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Inject plain air at cell 0 (inlet):</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>      <span class="n">mdot</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>  <span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">)</span>

    <span class="c1"># Inject a distributed flow of argon along the dilution region; notice</span>
    <span class="c1"># that in order to make the total flow independent of the discretized</span>
    <span class="c1"># cell length, it is made proportional to its values:</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">dilute</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="s2">&quot;AR: 1&quot;</span><span class="p">)</span>

    <span class="c1"># Perform the initial solution and fix:</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report_first</span><span class="p">)</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
<p>We said no convergence study was going to be performed; that was a lie. Below we inspect the evolution of final temperature in terms of reactor cell length in range <span class="math notranslate nohighlight">\(l\in[0.001;0.1]\)</span> m. Solution quickly approaches 340.6 K, and for practical purposes a discretization of 1 cm seems a good compromise between execution time and accuracy. Also notice that total supplied power may depend on discretization because of how it is provided.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">sample_single</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +2.500000e+02 |
| Total external power | W   | +6.035993e+03 |
| Final temperature    | K   | +3.404046e+02 |
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">sample_single</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +2.500000e+02 |
| Total external power | W   | +6.000357e+03 |
| Final temperature    | K   | +3.405258e+02 |
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">skipper</span> MJ_SOLVE_FINEST
model = sample_single(l=0.001)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Skipping cell: MJ_SOLVE_FINEST=True
</pre></div></div>
</div>
<p>Below we show the report of first solution, which here is no better than an initial guess; sequential solution of reactor towards steady state is recommended in practice.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">sample_single</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">report_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +2.500000e+02 |
| Total external power | W   | +6.000085e+03 |
| Final temperature    | K   | +3.395247e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +2.500000e+02 |
| Total external power | W   | +6.000085e+03 |
| Final temperature    | K   | +3.405501e+02 |
</pre></div></div>
</div>
<p>Finally we illustate the composition and temperature profiles induced by the simultaneous mass and heat transfer:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">quick_plot</span><span class="p">()</span>
<span class="n">plot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/advanced_plug__31_0.png" src="../_images/advanced_plug__31_0.png" />
</div>
</div>
<p>You can also access the data in base reactor for post-processing as desired:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>z_cell</th>
      <td>0.002500</td>
      <td>0.007500</td>
      <td>0.012500</td>
      <td>0.017500</td>
      <td>0.022500</td>
    </tr>
    <tr>
      <th>V_cell</th>
      <td>0.000039</td>
      <td>0.000039</td>
      <td>0.000039</td>
      <td>0.000039</td>
      <td>0.000039</td>
    </tr>
    <tr>
      <th>Q_cell</th>
      <td>1.177767</td>
      <td>3.489592</td>
      <td>5.744338</td>
      <td>7.943414</td>
      <td>10.088195</td>
    </tr>
    <tr>
      <th>m_cell</th>
      <td>0.000046</td>
      <td>0.000046</td>
      <td>0.000046</td>
      <td>0.000046</td>
      <td>0.000046</td>
    </tr>
    <tr>
      <th>mdot_cell</th>
      <td>0.050000</td>
      <td>0.050000</td>
      <td>0.050000</td>
      <td>0.050000</td>
      <td>0.050000</td>
    </tr>
    <tr>
      <th>T</th>
      <td>300.023321</td>
      <td>300.092416</td>
      <td>300.206156</td>
      <td>300.363436</td>
      <td>300.563179</td>
    </tr>
    <tr>
      <th>density</th>
      <td>1.171880</td>
      <td>1.171610</td>
      <td>1.171166</td>
      <td>1.170553</td>
      <td>1.169775</td>
    </tr>
    <tr>
      <th>Y_O2</th>
      <td>0.232909</td>
      <td>0.232909</td>
      <td>0.232909</td>
      <td>0.232909</td>
      <td>0.232909</td>
    </tr>
    <tr>
      <th>Y_N2</th>
      <td>0.767091</td>
      <td>0.767091</td>
      <td>0.767091</td>
      <td>0.767091</td>
      <td>0.767091</td>
    </tr>
    <tr>
      <th>Y_AR</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>
<section id="Counter-current-flow-reactors">
<h2>Counter-current flow reactors<a class="headerlink" href="#Counter-current-flow-reactors" title="Link to this heading">#</a></h2>
<p>The tooling required to compute a pair of reactors is already provided by <code class="docutils literal notranslate"><span class="pre">ReactorModel</span></code>; all we have to do is wrap a pair of reactors in <code class="docutils literal notranslate"><span class="pre">CounterCurrentReactors</span></code>. For convenience we store a copy of the axial coordinate (which is the same for both reactors). Notice here the introduction of <code class="docutils literal notranslate"><span class="pre">U</span></code>, a global heat transfer coefficient between phases, <code class="docutils literal notranslate"><span class="pre">Q</span></code>, the associated heat flux, and a relaxation manager.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CounterCurrentReactors</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wrap a pair of reactors and exchange heat between them. &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relax</span> <span class="o">=</span> <span class="n">RelaxUpdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>One cannot compute heat fluxes between reactors before having an initial temperature profile established (see it as an initial guess). Function <code class="docutils literal notranslate"><span class="pre">initialize</span></code> is provided for that end and must be called after mass flows have been setup.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; First solution for *initial guess*. &quot;&quot;&quot;</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>There are two ways one can solve the relaxation problem here, each with its strengths and weaknesses; one could simply calculate calculate the flux, apply it to both reactors, and solve (<code class="docutils literal notranslate"><span class="pre">iter_direct</span></code>) or compose a series of flux and solution calculations (<code class="docutils literal notranslate"><span class="pre">iter_alternate</span></code>). When initial guess is not good enough, the alternating approach tends to deliver results in a more reliable fashion (because it is compatible with high relaxation factors), but it is slower. On the other hand, direct
solution may converge faster as solution is already relaxed.</p>
<p><strong>IMPORTANT:</strong> notice here that we get the reverse of <code class="docutils literal notranslate"><span class="pre">T2</span></code> to compute flux (as the reactors are in counter-current) and then <code class="docutils literal notranslate"><span class="pre">model.Q</span></code> is reversed againt to set heat flux to reactor 2. This class could easily be generalized by adding a flag on whether temperature and flux should be treated as is (co-current) or reversed.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">iter_direct</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Strategy 1: compute flux, update both reactors. &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Q</span>
    <span class="n">model</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Q</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">iter_alternate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Strategy 2: sequentally compute flux and update a reactor. &quot;&quot;&quot;</span>
    <span class="c1"># Step 1:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Q</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Step 2:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Q</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Based on the previous discussion, a mixed approach can be proposed: relax the problem with the alternating solution and move to direct one after a certain criteria or maximum number of iterations has been achieved. This is emulated in <code class="docutils literal notranslate"><span class="pre">solve_pair</span></code> provided below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_pair</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;alternate&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_alternate</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
               <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Iterativelly solve pair of reactors with method. &quot;&quot;&quot;</span>
    <span class="n">converged</span> <span class="o">=</span> <span class="n">StabilizeNvarsConvergenceCheck</span><span class="p">(</span>
        <span class="n">n_vars</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="n">patience</span><span class="p">)</span>

    <span class="n">T1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
    <span class="n">count_alt</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">converged</span><span class="p">([</span><span class="n">T1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">T2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
            <span class="k">break</span>

        <span class="k">match</span> <span class="n">method</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;alternate&quot;</span><span class="p">:</span>
                <span class="n">iter_alternate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
                <span class="n">count_alt</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">count_alt</span> <span class="o">&gt;=</span> <span class="n">max_alternate</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="n">iter_direct</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>

        <span class="n">T1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<p>A simple standard ploting function is provided for the counter-current reactor pair:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@standard_plot</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">resized</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Plot pair of reactors in counter-current. &quot;&quot;&quot;</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">cp1</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">cp_mass</span>
    <span class="n">cp2</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">cp_mass</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cold fluid&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hot fluid&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">cp1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cold fluid&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">cp2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hot fluid&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">pair</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$T$ [K]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$c_p$ [J/(kg.K)]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$Q$ [W]&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Hot flow from right to left, cold flow left to right&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Example---pair-of-coupled-PFR">
<h3>Example - pair of coupled PFR<a class="headerlink" href="#Example---pair-of-coupled-PFR" title="Link to this heading">#</a></h3>
<p>This second example replaces the user-defined heat flow function by a convective heat exchange through a fin separating the reactions; this is modeled through a heat transfer coefficient <code class="docutils literal notranslate"><span class="pre">h</span></code> which is made constant here for illustration purposes only. To test the robustness of the approach, a relativelly high dilution flow is applied to a concentrated region in reactor 2 (hot stream).</p>
<p>After building the reactor pair, inlet and distributed conditions and the reactors are initialized, <em>.i.e.</em> solved individually, before iterative solution is performed. The user may require a final solution step for printing reactor quantities in a table.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_and_report</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Solve both reactors with results reporting. &quot;&quot;&quot;</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># O</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sample_pair</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;alternate&quot;</span><span class="p">,</span> <span class="n">final_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Pair of reactors model sample. &quot;&quot;&quot;</span>
    <span class="c1"># - PARAMETERS</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">100.0</span>

    <span class="c1"># - PROCESS</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="mi">300</span>         <span class="c1"># Temperature in channel 1 [K]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="mi">600</span>         <span class="c1"># Temperature in channel 2 [K]</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="mi">450</span>         <span class="c1"># Temperature of argon in channel 2 [K]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="mf">0.005</span>       <span class="c1"># Mass flow in channel 1 [kg/s]</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="mf">0.10</span>        <span class="c1"># Mass flow in channel 2 [kg/s]</span>

    <span class="c1"># - GEOMETRY</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mf">0.10</span>   <span class="c1"># Reactor diameter [m]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c1"># Reactor length [m]</span>

    <span class="c1"># Volume of a single cell [m³]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">D</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Area of exchange between cells [m²]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Discretize space and prepare inputs:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">dicretize_length</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">V1</span> <span class="o">=</span> <span class="n">V2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>

    <span class="c1"># Select region of reactor to apply dilution flow:</span>
    <span class="n">dilute</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">pair</span> <span class="o">=</span> <span class="n">CounterCurrentReactors</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="n">m1</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T1</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="n">m2</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T2</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">dilute</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="s2">&quot;AR: 1&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Td</span><span class="p">)</span>
    <span class="n">initialize</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>

    <span class="n">solve_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">final_solve</span><span class="p">:</span>
        <span class="n">solve_and_report</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">r2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pair</span>
</pre></div>
</div>
</div>
<p>For low relaxation values (<span class="math notranslate nohighlight">\(\alpha&lt;0.5\)</span>), both methods may eventually converge under the same number of iterations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pair</span> <span class="o">=</span> <span class="n">sample_pair</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;alternate&quot;</span><span class="p">,</span> <span class="n">final_solve</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.216871e+03 |
| Final temperature    | K   | +5.372994e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +1.600000e+02 |
| Total external power | W   | -1.216871e+03 |
| Final temperature    | K   | +5.615588e+02 |
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">skipper</span> MJ_SOLVE_FINEST
pair = sample_pair(l=0.010, alpha=0.3, method=&quot;not_alternate&quot;, final_solve=True)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Skipping cell: MJ_SOLVE_FINEST=True
</pre></div></div>
</div>
<p>Refining the grid for the present case has an impact of a few degrees over final solution (but takes much longer to solve), as illustrated below. Below 2 mm there is little change in the final solution and this value is a practical limit for grid refinement here.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">skipper</span> MJ_SOLVE_FINEST
pair = sample_pair(l=0.002, alpha=0.3, method=&quot;alternate&quot;, final_solve=True)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Skipping cell: MJ_SOLVE_FINEST=True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">skipper</span> MJ_SOLVE_FINEST
pair = sample_pair(l=0.001, alpha=0.1, method=&quot;alternate&quot;, final_solve=True, max_alternate=5)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Skipping cell: MJ_SOLVE_FINEST=True
</pre></div></div>
</div>
<p>Finally we display the results; for the hot stream we observe a sharp decrease in temperature (and associated specific heat capacity) due to argon dilution. Cold stream progressivelly heats up along the channel length as expected.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/advanced_plug__57_0.png" src="../_images/advanced_plug__57_0.png" />
</div>
</div>
</section>
</section>
<section id="Adding-losses-to-the-environment">
<h2>Adding losses to the environment<a class="headerlink" href="#Adding-losses-to-the-environment" title="Link to this heading">#</a></h2>
<p>So far we have developed the ideas required to reach the final goal of conceiving a fully coupled system with a pair of reactors and walls. Again we proceed with a wrapper class which countains our problem variables, but in this case we fully develop it as a single block. Also, this time documentation is provided in the class itself as that seems clearer to the author in this case, and provides some closure to the study.</p>
<p>The main increment in problem solution here is the extra step of solving for the wall temperature, which can be found from the global flux definition:</p>
<div class="math notranslate nohighlight">
\[\dot{Q}_{w} = \dfrac{T_w - T_e}{R_{tot}}
\quad\text{where}\quad
R_{tot} = \dfrac{1}{hA}+\dfrac{1}{2\pi{}lk}\log\dfrac{R_{ext}}{R_{int}}\]</div>
<p>We make use of the main takes of the previous sections, which have shown that alternating reactor solution order is not always an advantage; here the problem has been programmed to use direct solution. Relaxation is applied to reactor fluxes, but not to wall flux, which is computed from a balance of the relaxed quantities for the sake of energy conservation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FullCounterCurrentReactors</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Add external losses to a pair of coupled reactors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z: NDArray[np.float64]</span>
<span class="sd">        Coordinates of cell centers [m].</span>
<span class="sd">    V1: NDArray[np.float64]</span>
<span class="sd">        Volumes of cells of reactor 1 [m³].</span>
<span class="sd">    V2: NDArray[np.float64]</span>
<span class="sd">        Volumes of cells of reactor 2 [m³].</span>
<span class="sd">    U_inner: NDArray[np.float64]</span>
<span class="sd">        Global HTC between reactors [W/K].</span>
<span class="sd">    U_reac1: NDArray[np.float64]</span>
<span class="sd">        Global HTC between reactor 1 and wall [W/K].</span>
<span class="sd">    U_reac2: NDArray[np.float64]</span>
<span class="sd">        Global HTC between reactor 2 and wall [W/K].</span>
<span class="sd">    R_wall: NDArray[np.float64]</span>
<span class="sd">        Wall thermal resistance [K/W].</span>
<span class="sd">    alpha_: float = 0.8</span>
<span class="sd">        Relaxation factor for internal exchanges.</span>
<span class="sd">    Te: float = 300.0</span>
<span class="sd">        External environment temperature [K]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">V1</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
                 <span class="n">V2</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">U_inner</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
                 <span class="n">U_reac1</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">U_reac2</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
                 <span class="n">R_wall</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
                 <span class="n">Te</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Ui</span>  <span class="o">=</span> <span class="n">U_inner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U1</span>  <span class="o">=</span> <span class="n">U_reac1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U2</span>  <span class="o">=</span> <span class="n">U_reac2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rw</span>  <span class="o">=</span> <span class="n">R_wall</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Te</span>  <span class="o">=</span> <span class="n">Te</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qw</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relax_1</span> <span class="o">=</span> <span class="n">RelaxUpdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relax_2</span> <span class="o">=</span> <span class="n">RelaxUpdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_balances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Evaluate balances of all phases in system. &quot;&quot;&quot;</span>
        <span class="c1"># Compute all heat fluxes between system components.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q12</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ui</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span>       <span class="o">-</span> <span class="n">T2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">U1</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span>       <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">U2</span> <span class="o">*</span> <span class="p">(</span><span class="n">T2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relax_1</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">q12</span>        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relax_2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">q12</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># XXX: use overall by balance (no relax for energy conservation!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qw</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_direct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Strategy 1: compute flux, update both reactors. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_balances</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>

        <span class="c1"># Solve both reactors with updated fluxes:</span>
        <span class="n">solve_reactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">solve_reactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Solve steady-state radial heat transfer with resistance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Te</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qw</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rw</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_alternate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Strategy 2: sequentally compute flux and update a reactor. &quot;&quot;&quot;</span>
        <span class="c1"># Step 1: solve r1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_balances</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
        <span class="n">solve_reactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Step 2: solve r2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_balances</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
        <span class="n">solve_reactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Step 3: solve wall</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_balances</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Te</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qw</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rw</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_alternate</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Iterativelly solve pair of reactors with wall loss. &quot;&quot;&quot;</span>
        <span class="n">converged</span> <span class="o">=</span> <span class="n">StabilizeNvarsConvergenceCheck</span><span class="p">(</span>
            <span class="n">n_vars</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="n">patience</span><span class="p">)</span>
        <span class="n">count_alt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Tw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">converged</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Tw</span><span class="p">)]):</span>
                <span class="k">break</span>

            <span class="k">match</span> <span class="n">method</span><span class="p">:</span>
                <span class="k">case</span> <span class="s2">&quot;direct&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iter_direct</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
                <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iter_alternate</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
                    <span class="n">count_alt</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">count_alt</span> <span class="o">&gt;=</span> <span class="n">max_alternate</span><span class="p">:</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;direct&quot;</span>

            <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
            <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Tw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span>

    <span class="nd">@standard_plot</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">resized</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot fully integrated system. &quot;&quot;&quot;</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cold fluid&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hot fluid&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">reactor</span><span class="o">.</span><span class="n">Tw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Wall&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Q_{1,w}$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Q_{2,w}$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q12</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Q_{1,2}$&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$T$ [K]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$Q$ [W]&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Hot flow from right to left, cold flow left to right&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Example---environment-coupling">
<h3>Example - environment coupling<a class="headerlink" href="#Example---environment-coupling" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sample_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Sample case with a pair of coupled reactor and wall losses. &quot;&quot;&quot;</span>
    <span class="c1"># - PARAMETERS</span>
    <span class="n">h_inner</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># HTC r1-r2 [W/(m².K)]</span>
    <span class="n">h_reac1</span> <span class="o">=</span> <span class="mf">10.0</span>   <span class="c1"># HTC r1-wall [W/(m².K)]</span>
    <span class="n">h_reac2</span> <span class="o">=</span> <span class="mf">50.0</span>   <span class="c1"># HTC r2-wall [W/(m².K)]</span>
    <span class="n">h_shell</span> <span class="o">=</span> <span class="mf">10.0</span>   <span class="c1"># HTC shell-env [W/(m².K)]</span>
    <span class="n">k_shell</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c1"># Conductivity [W/(m.K)]</span>

    <span class="c1"># - PROCESS</span>
    <span class="n">Te</span> <span class="o">=</span> <span class="mi">298</span>         <span class="c1"># Environment temperature [K]</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="mi">300</span>         <span class="c1"># Temperature in channel 1 [K]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="mi">600</span>         <span class="c1"># Temperature in channel 2 [K]</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="mi">450</span>         <span class="c1"># Temperature of argon in channel 2 [K]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="mf">0.005</span>       <span class="c1"># Mass flow in channel 1 [kg/s]</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="mf">0.10</span>        <span class="c1"># Mass flow in channel 2 [kg/s]</span>

    <span class="c1"># - GEOMETRY</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>         <span class="c1"># Internal radius [m]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mf">0.07</span>         <span class="c1"># External radius [m]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.00</span>         <span class="c1"># Length of reactor [m]</span>

    <span class="c1"># Exchange areas [m²]</span>
    <span class="n">S_inner</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">l</span>
    <span class="n">S_reacn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">l</span>
    <span class="n">S_shell</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Semi-reactor volumes [m³]</span>
    <span class="n">V_half</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Discretize space and prepare inputs</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="mf">0.99</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">V1</span> <span class="o">=</span> <span class="n">V2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V_half</span><span class="p">)</span>
    <span class="n">U_inner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_inner</span> <span class="o">*</span> <span class="n">S_inner</span><span class="p">)</span>
    <span class="n">U_reac1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_reac1</span> <span class="o">*</span> <span class="n">S_reacn</span><span class="p">)</span>
    <span class="n">U_reac2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_reac2</span> <span class="o">*</span> <span class="n">S_reacn</span><span class="p">)</span>
    <span class="n">S_shell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_shell</span> <span class="o">*</span> <span class="n">S_shell</span><span class="p">)</span>

    <span class="n">R_shell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="n">k_shell</span><span class="p">)</span>
    <span class="n">R_env</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">S_shell</span> <span class="o">*</span> <span class="n">h_shell</span><span class="p">)</span>
    <span class="n">R_total</span> <span class="o">=</span> <span class="n">R_shell</span> <span class="o">+</span> <span class="n">R_env</span>

    <span class="c1"># Select region of reactor to apply dilution flow:</span>
    <span class="n">dilute</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">reactor</span> <span class="o">=</span> <span class="n">FullCounterCurrentReactors</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">U_inner</span><span class="p">,</span> <span class="n">U_reac1</span><span class="p">,</span> <span class="n">U_reac2</span><span class="p">,</span>
                                         <span class="n">R_total</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Te</span><span class="o">=</span><span class="n">Te</span><span class="p">)</span>

    <span class="n">add_source</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="n">m1</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T1</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="n">m2</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T2</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">dilute</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="s2">&quot;AR: 1&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Td</span><span class="p">)</span>
    <span class="n">initialize</span><span class="p">(</span><span class="n">reactor</span><span class="p">)</span>

    <span class="c1"># XXX: max_alternate greater than default to test the approach alone!</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_alternate</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">solve_and_report</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">reactor</span><span class="o">.</span><span class="n">r2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reactor</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reactor</span> <span class="o">=</span> <span class="n">sample_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.003972e+03 |
| Final temperature    | K   | +4.963894e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +3.000000e+02 |
| Total external power | W   | -2.210504e+03 |
| Final temperature    | K   | +5.216989e+02 |
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reactor</span> <span class="o">=</span> <span class="n">sample_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.153462e+03 |
| Final temperature    | K   | +5.251459e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +1.600000e+02 |
| Total external power | W   | -2.516963e+03 |
| Final temperature    | K   | +5.519201e+02 |
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">skipper</span> MJ_SOLVE_FINEST
reactor = sample_full(l=0.010, alpha=0.3, method=&quot;alternate&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Skipping cell: MJ_SOLVE_FINEST=True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">skipper</span> MJ_SOLVE_FINEST
reactor = sample_full(l=0.001, alpha=0.3)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Skipping cell: MJ_SOLVE_FINEST=True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/advanced_plug__67_0.png" src="../_images/advanced_plug__67_0.png" />
</div>
</div>
</section>
</section>
<section id="Registering-flow-for-a-single-reactor">
<h2>Registering flow for a single reactor<a class="headerlink" href="#Registering-flow-for-a-single-reactor" title="Link to this heading">#</a></h2>
<p>Below we develop further the idea into registering heat flows as an alternative to relaxation. The method may prove useful because heat flows are computed from current state of the reactors instead of an external guess.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sample_register_single</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">report_first</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Single reactor model sample. &quot;&quot;&quot;</span>
    <span class="c1"># - PARAMETERS ----------------------------------------------------</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">200.0</span>

    <span class="c1"># - PROCESS -------------------------------------------------------</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="mi">300</span>         <span class="c1"># Temperature in channel 1 [K]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="mi">600</span>         <span class="c1"># Temperature in channel 2 [K]</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="mi">450</span>         <span class="c1"># Temperature of argon in channel 2 [K]</span>

    <span class="c1"># - GEOMETRY ------------------------------------------------------</span>
    <span class="n">D</span> <span class="o">=</span> <span class="mf">0.10</span>   <span class="c1"># Reactor diameter [m]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c1"># Reactor length [m]</span>

    <span class="c1"># Volume of a single cell [m³]</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">D</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Area of exchange between cells [m²]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Discretize space and prepare inputs:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">dicretize_length</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>

    <span class="c1"># - REGISTER ------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heat_flow</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">T_reac</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute heat flow at cell `idx` [W]. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_reac</span> <span class="o">-</span> <span class="n">T2</span><span class="p">)</span>

    <span class="c1"># - SETUP ---------------------------------------------------------</span>
    <span class="c1"># Select region of reactor to apply dilution flow:</span>
    <span class="n">dilute</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">))</span>

    <span class="c1"># Create reactor with equal volume cells:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_heat_flow</span><span class="p">(</span><span class="n">heat_flow</span><span class="p">)</span>

    <span class="c1"># Enforce a zero a power supply function:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">add_source</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T1</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">dilute</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Td</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="s2">&quot;AR: 1&quot;</span><span class="p">)</span>

    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">solve_reactor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
<section id="Example---prototype-with-a-single-reactor">
<h3>Example - prototype with a single reactor<a class="headerlink" href="#Example---prototype-with-a-single-reactor" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">sample_register_single</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +2.500000e+02 |
| Total external power | W   | +4.237303e+03 |
| Final temperature    | K   | +4.232112e+02 |
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">quick_plot</span><span class="p">()</span>
<span class="n">plot</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/advanced_plug__73_0.png" src="../_images/advanced_plug__73_0.png" />
</div>
</div>
</section>
</section>
<section id="Registering-flow-for-a-pair-of-reactors">
<h2>Registering flow for a pair of reactors<a class="headerlink" href="#Registering-flow-for-a-pair-of-reactors" title="Link to this heading">#</a></h2>
<p>As a last level of improvement, we generalize the approach for a pair of reactors. After some experimentation it was concluded that falling back to the alternating approach with intermediate wall solution lead to the best performance, probably because of decreased system stifness. Relaxing the wall heat flow allows for faster convergence.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FullCounterCurrentReactorsWithRegister</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Add external losses to a pair of coupled reactors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z: NDArray[np.float64]</span>
<span class="sd">        Coordinates of cell centers [m].</span>
<span class="sd">    V1: NDArray[np.float64]</span>
<span class="sd">        Volumes of cells of reactor 1 [m³].</span>
<span class="sd">    V2: NDArray[np.float64]</span>
<span class="sd">        Volumes of cells of reactor 2 [m³].</span>
<span class="sd">    U_inner: NDArray[np.float64]</span>
<span class="sd">        Global HTC between reactors [W/K].</span>
<span class="sd">    U_reac1: NDArray[np.float64]</span>
<span class="sd">        Global HTC between reactor 1 and wall [W/K].</span>
<span class="sd">    U_reac2: NDArray[np.float64]</span>
<span class="sd">        Global HTC between reactor 2 and wall [W/K].</span>
<span class="sd">    R_wall: NDArray[np.float64]</span>
<span class="sd">        Wall thermal resistance [K/W].</span>
<span class="sd">    alpha_: float = 0.5</span>
<span class="sd">        Relaxation factor for internal exchanges.</span>
<span class="sd">    Te: float = 300.0</span>
<span class="sd">        External environment temperature [K]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">V1</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
                 <span class="n">V2</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">U_inner</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
                 <span class="n">U_reac1</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">U_reac2</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
                 <span class="n">R_wall</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span>
                 <span class="n">Te</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="n">ReactorModel</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Ui</span>  <span class="o">=</span> <span class="n">U_inner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U1</span>  <span class="o">=</span> <span class="n">U_reac1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U2</span>  <span class="o">=</span> <span class="n">U_reac2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rw</span>  <span class="o">=</span> <span class="n">R_wall</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Te</span>  <span class="o">=</span> <span class="n">Te</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">Te</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qw</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relax</span> <span class="o">=</span> <span class="n">RelaxUpdate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Qw</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># STEPWISE</span>
    <span class="c1"># -----------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_balances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Evaluate balances of all phases in system. &quot;&quot;&quot;</span>
        <span class="c1"># Compute all heat fluxes between system components.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q12</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ui</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span>       <span class="o">-</span> <span class="n">T2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">U1</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span>       <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">U2</span> <span class="o">*</span> <span class="p">(</span><span class="n">T2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">q12</span>        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">q12</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qw</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_wall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update wall solution with current state. &quot;&quot;&quot;</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_balances</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Te</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qw</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rw</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># WEAK COUPLING</span>
    <span class="c1"># -----------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cell_flows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute cell flows for a single pair. &quot;&quot;&quot;</span>
        <span class="n">q12</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ui</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T2</span><span class="p">)</span>
        <span class="n">q1w</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">U1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">T1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">q2w</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">U2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">T2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_wall</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Te</span> <span class="o">-</span> <span class="p">(</span><span class="n">q1w</span> <span class="o">+</span> <span class="n">q2w</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">q12</span><span class="p">,</span> <span class="n">q1w</span><span class="p">,</span> <span class="n">q2w</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># CORE STEPS</span>
    <span class="c1"># -----------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_heat_flow_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
        <span class="n">q12</span><span class="p">,</span> <span class="n">q1w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cell_flows</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">-</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="o">+</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q12</span> <span class="o">+</span> <span class="n">q1w</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_heat_flow_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
        <span class="n">q12</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">q2w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cell_flows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">-</span><span class="n">k</span><span class="p">,</span> <span class="n">T1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="o">-</span><span class="n">k</span><span class="p">],</span> <span class="n">T2</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">q12</span> <span class="o">+</span> <span class="n">q2w</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_solve_r1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">heat_flow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heat_flow_1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_heat_flow</span><span class="p">(</span><span class="n">heat_flow</span><span class="p">)</span>
        <span class="n">solve_reactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_solve_r2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T1</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">heat_flow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heat_flow_2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">Q</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_heat_flow</span><span class="p">(</span><span class="n">heat_flow</span><span class="p">)</span>
        <span class="n">solve_reactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># ALGORITHM SELECTION</span>
    <span class="c1"># -----------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Perform a single iteration of solution. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solve_wall</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;weak&quot;</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">method</span><span class="p">:</span>
            <span class="k">case</span> <span class="s2">&quot;step_alt&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_wall</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_wall</span><span class="p">()</span>

            <span class="k">case</span> <span class="s2">&quot;step_seq&quot;</span><span class="p">:</span>
                <span class="n">T1_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
                <span class="n">T2_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r1</span><span class="p">(</span><span class="n">T2_now</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_wall</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r2</span><span class="p">(</span><span class="n">T1_now</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_wall</span><span class="p">()</span>

            <span class="k">case</span> <span class="s2">&quot;weak_alt&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

            <span class="k">case</span> <span class="s2">&quot;weak_seq&quot;</span><span class="p">:</span>
                <span class="n">T1_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
                <span class="n">T2_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r1</span><span class="p">(</span><span class="n">T2_now</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_r2</span><span class="p">(</span><span class="n">T1_now</span><span class="p">)</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># API</span>
    <span class="c1"># -----------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;solve_alt&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Iterativelly solve pair of reactors with wall loss. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">conv</span> <span class="o">=</span> <span class="n">ComposedStabilizedConvergence</span><span class="p">(</span>
            <span class="mi">3</span><span class="p">,</span> <span class="n">n_vars</span><span class="o">=</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="n">patience</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Tw</span><span class="p">):</span>
                <span class="n">bal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_residual</span><span class="p">())</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">bal</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">bal</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converged after </span><span class="si">{</span><span class="n">conv</span><span class="o">.</span><span class="n">n_iterations</span><span class="si">}</span><span class="s2"> iterations &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;with maximum residual of </span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2"> at cell </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_iterate</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Evaluate reactor residual of energy flow. &quot;&quot;&quot;</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_balances</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>

        <span class="n">Qw</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q1w</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span><span class="p">)</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">Q_cell</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">Q_cell</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Q1</span> <span class="o">+</span> <span class="n">Q2</span> <span class="o">+</span> <span class="n">Qw</span>

    <span class="nd">@standard_plot</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">resized</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Display residual of energy balance over length. &quot;&quot;&quot;</span>
        <span class="n">bal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_residual</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">bal</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Balance [W]&quot;</span><span class="p">)</span>

    <span class="nd">@standard_plot</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">resized</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot fully integrated system. &quot;&quot;&quot;</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">T</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cold fluid&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hot fluid&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">reactor</span><span class="o">.</span><span class="n">Tw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Wall&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q1w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Q_{1,w}$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q2w</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Q_{2,w}$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q12</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$Q_{1,2}$&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;z [m]&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$T$ [K]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$Q$ [W]&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Hot flow from right to left, cold flow left to right&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Example---extension-to-coupled-system">
<h3>Example - extension to coupled system<a class="headerlink" href="#Example---extension-to-coupled-system" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sample_register_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;method-2&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Sample case with a pair of coupled reactor and wall losses. &quot;&quot;&quot;</span>
    <span class="c1"># - PARAMETERS</span>
    <span class="n">h_inner</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># HTC r1-r2 [W/(m².K)]</span>
    <span class="n">h_reac1</span> <span class="o">=</span> <span class="mf">10.0</span>   <span class="c1"># HTC r1-wall [W/(m².K)]</span>
    <span class="n">h_reac2</span> <span class="o">=</span> <span class="mf">50.0</span>   <span class="c1"># HTC r2-wall [W/(m².K)]</span>
    <span class="n">h_shell</span> <span class="o">=</span> <span class="mf">10.0</span>   <span class="c1"># HTC shell-env [W/(m².K)]</span>
    <span class="n">k_shell</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c1"># Conductivity [W/(m.K)]</span>

    <span class="c1"># - PROCESS</span>
    <span class="n">Te</span> <span class="o">=</span> <span class="mi">298</span>         <span class="c1"># Environment temperature [K]</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="mi">300</span>         <span class="c1"># Temperature in channel 1 [K]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="mi">600</span>         <span class="c1"># Temperature in channel 2 [K]</span>
    <span class="n">Td</span> <span class="o">=</span> <span class="mi">450</span>         <span class="c1"># Temperature of argon in channel 2 [K]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="mf">0.005</span>       <span class="c1"># Mass flow in channel 1 [kg/s]</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="mf">0.10</span>        <span class="c1"># Mass flow in channel 2 [kg/s]</span>

    <span class="c1"># - GEOMETRY</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>         <span class="c1"># Internal radius [m]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mf">0.07</span>         <span class="c1"># External radius [m]</span>
    <span class="n">L</span> <span class="o">=</span> <span class="mf">1.00</span>         <span class="c1"># Length of reactor [m]</span>

    <span class="c1"># Exchange areas [m²]</span>
    <span class="n">S_inner</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">l</span>
    <span class="n">S_reacn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">l</span>
    <span class="n">S_shell</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Semi-reactor volumes [m³]</span>
    <span class="n">V_half</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span>

    <span class="c1"># Discretize space and prepare inputs</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">L</span><span class="o">-</span><span class="mf">0.99</span><span class="o">*</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">V1</span> <span class="o">=</span> <span class="n">V2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">V_half</span><span class="p">)</span>
    <span class="n">U_inner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_inner</span> <span class="o">*</span> <span class="n">S_inner</span><span class="p">)</span>
    <span class="n">U_reac1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_reac1</span> <span class="o">*</span> <span class="n">S_reacn</span><span class="p">)</span>
    <span class="n">U_reac2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_reac2</span> <span class="o">*</span> <span class="n">S_reacn</span><span class="p">)</span>
    <span class="n">S_shell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">h_shell</span> <span class="o">*</span> <span class="n">S_shell</span><span class="p">)</span>

    <span class="n">R_shell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="n">k_shell</span><span class="p">)</span>
    <span class="n">R_env</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">S_shell</span> <span class="o">*</span> <span class="n">h_shell</span><span class="p">)</span>
    <span class="n">R_total</span> <span class="o">=</span> <span class="n">R_shell</span> <span class="o">+</span> <span class="n">R_env</span>

    <span class="c1"># Select region of reactor to apply dilution flow:</span>
    <span class="n">dilute</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">reactor</span> <span class="o">=</span> <span class="n">FullCounterCurrentReactorsWithRegister</span><span class="p">(</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">U_inner</span><span class="p">,</span> <span class="n">U_reac1</span><span class="p">,</span> <span class="n">U_reac2</span><span class="p">,</span> <span class="n">R_total</span><span class="p">,</span> <span class="n">Te</span><span class="o">=</span><span class="n">Te</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>

    <span class="n">add_source</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="n">m1</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T1</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="n">m2</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="n">X_AIR</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T2</span><span class="p">)</span>
    <span class="n">add_source</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">dilute</span><span class="p">,</span> <span class="n">mdot</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">l</span><span class="p">,</span>  <span class="n">X</span><span class="o">=</span><span class="s2">&quot;AR: 1&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">Td</span><span class="p">)</span>
    <span class="n">initialize</span><span class="p">(</span><span class="n">reactor</span><span class="p">)</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">use_smooth_flux</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">use_smooth_flux</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="n">solve_and_report</span><span class="p">(</span><span class="n">reactor</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">reactor</span><span class="o">.</span><span class="n">r2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reactor</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">reactor</span> <span class="o">=</span> <span class="n">sample_register_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;weak_alt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Converged after 50 iterations with maximum residual of 2.210593e-08 at cell 98
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.153462e+03 |
| Final temperature    | K   | +5.251459e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +1.600000e+02 |
| Total external power | W   | -2.516963e+03 |
| Final temperature    | K   | +5.519201e+02 |
CPU times: user 7.24 s, sys: 134 ms, total: 7.37 s
Wall time: 7.24 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">reactor</span> <span class="o">=</span> <span class="n">sample_register_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;weak_seq&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Converged after 50 iterations with maximum residual of 2.201708e-08 at cell 99
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.153462e+03 |
| Final temperature    | K   | +5.251459e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +1.600000e+02 |
| Total external power | W   | -2.516963e+03 |
| Final temperature    | K   | +5.519201e+02 |
CPU times: user 8.1 s, sys: 156 ms, total: 8.26 s
Wall time: 8.09 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/advanced_plug__81_0.png" src="../_images/advanced_plug__81_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">reactor</span> <span class="o">=</span> <span class="n">sample_register_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;step_alt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Converged after 50 iterations with maximum residual of 2.518874e-12 at cell 0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.153462e+03 |
| Final temperature    | K   | +5.251459e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +1.600000e+02 |
| Total external power | W   | -2.516963e+03 |
| Final temperature    | K   | +5.519201e+02 |
CPU times: user 6.5 s, sys: 88.3 ms, total: 6.59 s
Wall time: 6.51 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">reactor</span> <span class="o">=</span> <span class="n">sample_register_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;step_seq&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Converged after 50 iterations with maximum residual of 5.757173e-11 at cell 0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.153462e+03 |
| Final temperature    | K   | +5.251459e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +1.600000e+02 |
| Total external power | W   | -2.516963e+03 |
| Final temperature    | K   | +5.519201e+02 |
CPU times: user 7.16 s, sys: 179 ms, total: 7.34 s
Wall time: 7.2 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/advanced_plug__84_0.png" src="../_images/advanced_plug__84_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">reactor</span> <span class="o">=</span> <span class="n">sample_full</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +5.000000e+00 |
| Total external power | W   | +1.153462e+03 |
| Final temperature    | K   | +5.251459e+02 |
|----------------------|-----|---------------|
| Total mass flow rate | g/s | +1.600000e+02 |
| Total external power | W   | -2.516963e+03 |
| Final temperature    | K   | +5.519201e+02 |
CPU times: user 3.5 s, sys: 26.9 ms, total: 3.53 s
Wall time: 3.5 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/advanced_plug__86_0.png" src="../_images/advanced_plug__86_0.png" />
</div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Advanced</p>
      </div>
    </a>
    <a class="right-next"
       href="plug_phd_.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Acetylene pyrolysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Shared-functionalities">Shared functionalities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Single-plug-flow-reactor">Single plug-flow reactor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---single-PFR-simulation">Example - single PFR simulation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Counter-current-flow-reactors">Counter-current flow reactors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---pair-of-coupled-PFR">Example - pair of coupled PFR</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Adding-losses-to-the-environment">Adding losses to the environment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---environment-coupling">Example - environment coupling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Registering-flow-for-a-single-reactor">Registering flow for a single reactor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---prototype-with-a-single-reactor">Example - prototype with a single reactor</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Registering-flow-for-a-pair-of-reactors">Registering flow for a pair of reactors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Example---extension-to-coupled-system">Example - extension to coupled system</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Walter Dal'Maz Silva
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Walter Dal&#39;Maz Silva.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>